# 网页预览页面说明文档

## 概述

这是一个基于 Vue 3 + TypeScript + Element Plus 的网页预览页面，主要用于通过 AI 生成和预览网页内容。页面集成了 Dify AI 工作流，支持流式响应和实时预览功能。

## 页面结构

### 1. 主要功能区域

#### 1.1 预览窗口区域
- **位置**: 页面上方，占据主要空间
- **功能**: 显示 AI 生成的网页内容
- **特点**:
  - 使用 iframe 安全渲染 HTML 内容
  - 支持沙箱模式，确保安全性
  - 响应式设计，适配不同屏幕尺寸

#### 1.2 输入控制区域
- **位置**: 页面下方
- **功能**: 用户输入修改要求
- **组件**:
  - 多行文本输入框（支持自动调整高度）
  - "修改" 复选框（控制修改模式）
  - 提交按钮

### 2. 核心功能

#### 2.1 AI 网页生成
- **首次生成**: 基于传入的预览数据生成初始网页
- **修改模式**: 基于现有内容进行修改
- **流式响应**: 实时显示生成过程

#### 2.2 两种工作模式

##### 流式模式（默认）
- **特点**: 实时显示生成过程
- **适用场景**: 首次生成或需要看到生成过程
- **响应模式**: `streaming`

##### 阻塞模式
- **特点**: 等待完整生成后一次性显示
- **适用场景**: 修改现有内容
- **响应模式**: `blocking`

#### 2.3 数据管理
- **本地存储**: 使用 localStorage 保存预览数据
- **数据过期**: 24小时自动清理过期数据
- **状态管理**: 使用 Pinia 进行全局状态管理

## 技术实现

### 1. 技术栈
- **前端框架**: Vue 3 (Composition API)
- **类型系统**: TypeScript
- **UI 组件库**: Element Plus
- **状态管理**: Pinia
- **HTTP 请求**: hook-fetch
- **路由**: Vue Router

### 2. 核心 API 集成

#### 2.1 Dify AI 工作流
```typescript
// 预览请求接口
export function send_message_stream_preview(data: PreviewRequest) {
  return difyPreviewRequest.post('/workflows/run', data);
}
```

#### 2.2 请求数据结构
```typescript
interface PreviewRequest {
  inputs: {
    sourceContent: string;    // 源内容
    updateContext: string;    // 修改上下文
    isUpdate: number;         // 是否更新（0=修改，1=新建）
    model: string;           // 模型选择
  };
  sourceContent: string;
  updateContext: string;
  isUpdate: number;
  response_mode: 'streaming' | 'blocking';
  user: string;
}
```

### 3. 流式数据处理

#### 3.1 事件类型
- `workflow_started`: 工作流开始
- `workflow_finished`: 工作流完成
- `error`: 错误事件

#### 3.2 数据处理流程
1. 接收流式数据块
2. 实时更新瀑布流显示
3. 工作流完成时保存最终内容
4. 更新状态管理

### 4. 安全特性

#### 4.1 iframe 沙箱
```html
<iframe
  :srcdoc="generatedContent"
  sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals"
></iframe>
```

#### 4.2 数据清理
- 页面关闭时自动清理当前预览数据
- 定期清理过期的 localStorage 数据

## 用户交互流程

### 1. 页面初始化
1. 清理过期数据
2. 从 URL 参数获取预览 ID
3. 从 localStorage 加载预览数据
4. 设置到全局状态

### 2. 内容生成流程
1. 用户输入或系统自动触发
2. 构建 API 请求数据
3. 发送流式请求
4. 实时显示生成过程
5. 保存最终结果

### 3. 内容修改流程
1. 用户勾选"修改"复选框
2. 输入修改要求
3. 基于现有内容进行修改
4. 更新预览显示

## 样式设计

### 1. 布局特点
- **全屏高度**: `height: 100vh`
- **弹性布局**: 使用 Flexbox
- **响应式**: 支持移动端适配

### 2. 视觉效果
- **代码生成动画**: 模拟代码瀑布流效果
- **加载状态**: 优雅的加载提示
- **空状态**: 友好的空内容提示

### 3. 主题适配
- 支持明暗主题切换
- 统一的色彩系统
- 现代化的 UI 设计

## 错误处理

### 1. 网络错误
- API 请求失败提示
- 流式请求中断处理

### 2. 数据错误
- 预览数据解析失败
- 过期数据清理

### 3. 用户操作错误
- 空输入验证
- 操作状态管理

## 性能优化

### 1. 内存管理
- 及时清理不需要的数据
- 避免内存泄漏

### 2. 渲染优化
- 使用 `nextTick` 确保 DOM 更新
- 合理的状态更新策略

### 3. 网络优化
- 流式请求减少等待时间
- 合理的错误重试机制

## 扩展性

### 1. 模块化设计
- 组件化开发
- 可复用的功能模块

### 2. 配置化
- 支持不同环境配置
- 灵活的 API 配置

### 3. 类型安全
- 完整的 TypeScript 类型定义
- 编译时错误检查

## 使用说明

### 1. 基本使用
1. 通过 URL 参数传入预览 ID
2. 页面自动加载并生成内容
3. 在输入框中输入修改要求
4. 点击提交进行修改

### 2. 高级功能
1. 勾选"修改"复选框启用修改模式
2. 支持多轮对话修改
3. 实时预览生成效果

### 3. 注意事项
1. 确保网络连接正常
2. 预览数据有 24 小时过期时间
3. 修改模式需要现有内容作为基础

## 总结

这个网页预览页面是一个功能完善的 AI 驱动的内容生成和预览系统，具有以下特点：

1. **用户友好**: 直观的界面设计和流畅的交互体验
2. **技术先进**: 使用最新的前端技术栈和最佳实践
3. **功能完整**: 支持生成、修改、预览等完整工作流
4. **安全可靠**: 完善的安全机制和错误处理
5. **可扩展**: 模块化设计便于后续功能扩展

该页面为 AI 网页生成应用提供了强大的预览和编辑能力，是现代化 Web 应用开发的优秀示例。
